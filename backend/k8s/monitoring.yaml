# Prometheus ServiceMonitor for Nexa Backend
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nexa-backend
  namespace: nexa-production
  labels:
    app: nexa-backend
    release: prometheus
spec:
  selector:
    matchLabels:
      app: nexa-backend
  namespaceSelector:
    matchNames:
    - nexa-production
  endpoints:
  - port: http
    interval: 30s
    scrapeTimeout: 10s
    path: /metrics
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_container_port_name]
      action: keep
      regex: http
    metricRelabelings:
    - sourceLabels: [__name__]
      regex: 'go_.*'
      action: drop
---
# Custom metrics configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: nexa-prometheus-rules
  namespace: nexa-production
data:
  nexa-rules.yml: |
    groups:
    - name: nexa-backend
      rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on {{ $labels.instance }}"
          description: "Error rate is {{ $value }}%"
      
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time on {{ $labels.instance }}"
          description: "95th percentile response time is {{ $value }}s"
      
      - alert: ServiceDown
        expr: up{job="nexa-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.instance }} is down"
          description: "The service has been down for more than 1 minute"
      
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value }}%"
      
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value }}%"
      
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/app/uploads"} / node_filesystem_size_bytes{mountpoint="/app/uploads"}) * 100 < 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Disk space is {{ $value }}%"
---
# Grafana dashboard configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: nexa-grafana-dashboard
  namespace: nexa-production
  labels:
    grafana_dashboard: "1"
data:
  nexa-backend.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Nexa Backend",
        "tags": ["nexa", "backend"],
        "style": "dark",
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "graph",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "rate(http_requests_total[5m])",
                "legendFormat": "{{method}} {{status}}",
                "refId": "A"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Response Time",
            "type": "graph",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile",
                "refId": "A"
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "Error Rate",
            "type": "stat",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m]) * 100",
                "legendFormat": "Error Rate",
                "refId": "A"
              }
            ],
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "Active Users",
            "type": "stat",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "nexa_active_users",
                "legendFormat": "Active Users",
                "refId": "A"
              }
            ],
            "gridPos": {
              "h": 4,
              "w": 6,
              "x": 6,
              "y": 8
            }
          },
          {
            "id": 5,
            "title": "CPU Usage",
            "type": "gauge",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "rate(process_cpu_seconds_total[5m]) * 100",
                "legendFormat": "CPU Usage",
                "refId": "A"
              }
            ],
            "gridPos": {
              "h": 6,
              "w": 8,
              "x": 0,
              "y": 12
            }
          },
          {
            "id": 6,
            "title": "Memory Usage",
            "type": "gauge",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "process_resident_memory_bytes / 1024 / 1024",
                "legendFormat": "Memory Usage (MB)",
                "refId": "A"
              }
            ],
            "gridPos": {
              "h": 6,
              "w": 8,
              "x": 8,
              "y": 12
            }
          }
        ],
        "time": {
          "from": "now-6h",
          "to": "now"
        }
      }
    }